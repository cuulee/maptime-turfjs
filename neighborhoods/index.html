<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Leaflet Draw</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.0-rc.2/dist/leaflet.css" />
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.3/leaflet.draw.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>

<script src="https://npmcdn.com/leaflet@1.0.0-rc.2/dist/leaflet.js"></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.3/leaflet.draw.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>


<div id='map'></div>

<script>
  // CONFIGURE THE MAP
  var map = L.map('map')
    .setView([42.35070, -71.08102], 15);

  L.tileLayer('http://tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design<\/a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0<\/a>. Data by <a href="http://openstreetmap.org">OpenStreetMap<\/a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA<\/a>.',
    maxZoom: 18
  }).addTo(map);

  // CONFIGURE THE DRAWING BEHAVIOR AND LAYERS
  var featureGroup = L.featureGroup().addTo(map);
  var pointLayer;

  var drawControl = new L.Control.Draw({
    position: 'topright',
    edit: {
      featureGroup: featureGroup
    },
    draw: {
      polyline: false,
      marker: false,
      circle: false,
      rectangle: false
    }
  }).addTo(map);

  drawControl.setDrawingOptions({
    polygon: {
      shapeOptions: {
        weight: 2,
        opacity: 1,
        color: '#e2e3e3',
        fillOpacity: 0.3
      }
    }
  });

  map.on('draw:created', function(e) {
    // ADD THE DRAWN LAYER TO THE COLLECTION
    featureGroup.addLayer(e.layer);
    // TURN IT INTO GEOJSON TO USE W/ TURF
    var data = featureGroup.toGeoJSON();
    // CALCULATE THE BOUNDING BOX TO GENERATE THE GRID
    var bbox = turf.bbox(data);
    // GENERATE THE GRID
    var pointGrid = turf.pointGrid(bbox, 50, 'meters');
    // PREPARE THE DRAWINGS FOR TOPOLOGY TESTS
    var featureUnion = turf.combine(data);
    // CREATE A SHELL GEOJSON FOR THE PROCESSED POINT GRID
    var finalGrid = {"type": "FeatureCollection","features": []};
    // ADD POINTS TO THE GRID ONLY IF THEY OVERLAP A DRAWING
    for (var i = 0; i < pointGrid.features.length; i++) {
      if (turf.inside(pointGrid.features[i], featureUnion.features[0]) == true ) {
        var pointHere = pointGrid.features[i];
        // ITERATE THROUGH THE DRAWINGS, SUMMING UP THE AGREEMENT
        pointHere.properties.drawings = 0;
        for (var d = 0; d < data.features.length; d++) {
          if (turf.inside(pointHere, data.features[d]) == true ) {
            pointHere.properties.drawings++
          }
        }
        finalGrid.features.push(pointHere);
      }
    }
    // ADD THE POINT GRID TO THE MAP (OR REFRESH IT)
    if (map.hasLayer(pointLayer)) {
      map.removeLayer(pointLayer);
    }
    pointLayer = L.geoJson(finalGrid, {

			style: function (feature) {
				return feature.properties && feature.properties.style;
			},
			pointToLayer: function (feature, latlng) {
				return L.circleMarker(latlng, {
					radius: feature.properties.drawings,
					fillColor: "#2D518B",
					color: "#2D518B",
					weight: 0.2,
					opacity: 0.9,
					fillOpacity: 0.8
				});
			}
		}).addTo(map);

  });
</script>
</body>
</html>
